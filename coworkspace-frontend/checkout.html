<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Checkout Prenotazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/forms.css">
</head>
<body class="page-soft">
<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="dashboard.html">← Dashboard</a>
</nav>

<div class="container center-hero">
    <div class="booking-card w-100" style="max-width: 680px;">
        <h1 class="title-lg">Riepilogo prenotazione</h1>

        <div id="summary" class="mb-3 text-muted small">Caricamento…</div>

        <div class="field-rail">
            <div class="rail-icon"><span class="tiny-box"></span></div>
            <input class="form-control rail-input" placeholder="Numero carta (simulato)">
        </div>

        <div class="d-flex gap-2 mt-3">
            <button id="payBtn" class="btn btn-primary px-4">Paga ora</button>
            <a href="dashboard.html" class="btn btn-outline-secondary px-4">Annulla</a>
        </div>

        <div id="status" class="mt-3 text-muted"></div>
    </div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const rid = params.get('rid');
    const token = localStorage.getItem('jwt_token');

    // Carica tutte le prenotazioni dell'utente
    async function loadReservation() {
        const summary = document.getElementById('summary');
        if (!token) { summary.textContent = 'Token mancante.'; return; }

        try {
            const res = await fetch('http://localhost:3000/reservations/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw 0;
            const reservations = await res.json();

            if (!reservations.length) {
                summary.textContent = 'Nessuna prenotazione trovata.';
                return;
            }

            summary.innerHTML = reservations.map(r => {
                const priceCents = r.price_cents ?? (r.price ? Math.round(Number(r.price) * 100) : 0);
                const euro = (priceCents/100).toFixed(2).replace('.', ',');
                return `
                <div class="mb-3 border-bottom pb-2">
                    <div><strong>Prenotazione #${r.id}</strong></div>
                    ${r.location_name ? `<div>Sede: ${r.location_name}</div>` : ''}
                    ${r.space_name ? `<div>Spazio: ${r.space_name}</div>` : ''}
                    ${r.date ? `<div>Data: ${r.date}</div>` : ''}
                    ${(r.start_time && r.end_time) ? `<div>Orario: ${r.start_time} – ${r.end_time}</div>` : ''}
                    <div class="mt-1"><strong>Totale: € ${euro}</strong></div>
                </div>
            `;
            }).join('');
        } catch (e) {
            summary.textContent = 'Impossibile caricare le prenotazioni.';
            console.error(e);
        }
    }

    document.getElementById('payBtn').addEventListener('click', async () => {
        const btn = document.getElementById('payBtn');
        const status = document.getElementById('status');
        btn.disabled = true; status.textContent = 'Avvio pagamento…';
        try {
            // 1) crea pagamento mock
            const startRes = await fetch('http://localhost:3000/payments/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ reservation_id: rid })
            });
            if (!startRes.ok) throw await startRes.json();
            const start = await startRes.json();

            // 2) conferma pagamento mock
            status.textContent = 'Conferma pagamento…';
            const confRes = await fetch('http://localhost:3000/payments/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ paymentId: start.paymentId })
            });
            if (!confRes.ok) throw await confRes.json();

            // 3) fine
            location.href = 'dashboard.html?paid=1';
        } catch (e) {
            status.textContent = (e && e.message) ? e.message : 'Errore nel pagamento.';
            btn.disabled = false;
        }
    });

    loadReservation();
</script>
</body>
</html>
