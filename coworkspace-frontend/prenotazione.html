<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prenota uno Spazio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .slot-cell {
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .slot-cell:hover {
            background-color: #f0f0f0;
        }
        .slot-booked {
            background-color: #ffcccc;
            cursor: not-allowed;
        }
        .slot-selected {
            background-color: #c6f6d5;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="index.html">üè† Home</a>
    <div class="ms-auto">
        <a href="dashboard.html" class="btn btn-outline-light btn-sm">Dashboard</a>
    </div>
</nav>

<div class="container my-4">
    <h2>Prenota uno Spazio</h2>

    <div class="row mb-3">
        <div class="col-md-6">
            <label for="location-select" class="form-label">Sede</label>
            <select id="location-select" class="form-select"></select>
        </div>
        <div class="col-md-6">
            <label for="space-select" class="form-label">Spazio</label>
            <select id="space-select" class="form-select" disabled></select>
        </div>
    </div>

    <div class="mb-3">
        <label for="reservation-date" class="form-label">Data</label>
        <input type="date" id="reservation-date" class="form-control" disabled />
    </div>

    <div class="mt-4" id="slots-grid"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    const token = localStorage.getItem('jwt_token');
    if (!token) window.location.href = 'login.html';

    let selectedSpace = null;
    let selectedDate = null;
    let selectedSlot = null;

    // Carica le location
    $.get('http://localhost:3000/locations', function (locations) {
        const select = $('#location-select');
        select.append('<option value="">-- Seleziona sede --</option>');
        locations.forEach(loc => {
            select.append(`<option value="${loc.id}">${loc.name} - ${loc.city}</option>`);
        });
    });

    // Quando selezioni una sede, carica gli spazi
    $('#location-select').on('change', function () {
        const locationId = $(this).val();
        $('#space-select').empty().prop('disabled', true);
        $('#reservation-date').val('').prop('disabled', true);
        $('#slots-grid').empty();

        if (!locationId) return;

        $.get('http://localhost:3000/spaces', function (spaces) {
            const filtered = spaces.filter(s => s.location_id == locationId);
            const select = $('#space-select');
            select.append('<option value="">-- Seleziona spazio --</option>');
            filtered.forEach(space => {
                select.append(`<option value="${space.id}">${space.type} - ‚Ç¨${space.price}</option>`);
            });
            select.prop('disabled', false);
        });
    });

    // Quando selezioni uno spazio
    $('#space-select').on('change', function () {
        selectedSpace = $(this).val();
        $('#reservation-date').prop('disabled', !selectedSpace);
        $('#slots-grid').empty();
    });

    // Quando selezioni una data
    $('#reservation-date').on('change', function () {
        selectedDate = $(this).val();
        if (!selectedSpace || !selectedDate) return;

        $.ajax({
            url: `http://localhost:3000/availability/dynamic?space_id=${selectedSpace}&date=${selectedDate}`,
            headers: { Authorization: `Bearer ${token}` },
            success: function (slots) {
                const container = $('#slots-grid');
                container.empty();
                container.append('<h5>Seleziona una fascia oraria:</h5>');

                const row = $('<div class="d-flex flex-wrap gap-2 mt-3"></div>');
                for (let h = 8; h < 24; h++) {
                    const start = `${String(h).padStart(2, '0')}:00`;
                    const end = `${String(h + 1).padStart(2, '0')}:00`;

                    const booked = !slots.some(s => s.start_time === start);
                    const slotDiv = $(`<div class="slot-cell ${booked ? 'slot-booked' : ''}">${start} - ${end}</div>`);

                    if (!booked) {
                        slotDiv.click(function () {
                            $('.slot-cell').removeClass('slot-selected');
                            $(this).addClass('slot-selected');
                            selectedSlot = { start_time: start, end_time: end };

                            // Conferma immediata
                            if (confirm(`Confermi la prenotazione per il ${selectedDate} dalle ${start} alle ${end}?`)) {
                                $.ajax({
                                    url: 'http://localhost:3000/reservations',
                                    method: 'POST',
                                    headers: {
                                        Authorization: `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    data: JSON.stringify({
                                        space_id: selectedSpace,
                                        date: selectedDate,
                                        start_time: start,
                                        end_time: end
                                    }),
                                    success: () => {
                                        alert('Prenotazione confermata!');
                                        window.location.href = 'dashboard.html';
                                    },
                                    error: () => alert('Errore nella prenotazione.')
                                });
                            }
                        });
                    }
                    row.append(slotDiv);
                }
                container.append(row);
            },
            error: function () {
                $('#slots-grid').html('<p class="text-danger">Errore nel caricamento degli orari.</p>');
            }
        });
    });
</script>
</body>
</html>
